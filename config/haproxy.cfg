global
    daemon
    maxconn 4096
    log stdout local0 info

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    option dontlognull
    option redispatch
    retries 3

# HAProxy Stats Interface
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Main MCP Load Balancer Frontend
frontend mcp_frontend
    bind *:80
    option httplog
    
    # Health check endpoint
    acl is_health path /health
    
    # Route to appropriate backend
    default_backend mcp_backend

# MCP Backend Pool
backend mcp_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # Primary server (Ubuntu Desktop) - higher weight
    server ubuntu-primary 172.30.0.10:8080 check weight 3 maxconn 1000
    
    # Pi replicas (will be added dynamically by Coolify)
    # These will be configured via Coolify's service discovery
    # server pi1 PI1_IP:8080 check weight 1 maxconn 200
    # server pi2 PI2_IP:8080 check weight 1 maxconn 200
    # server pi3 PI3_IP:8080 check weight 1 maxconn 200

# Monitoring Backend (optional)
frontend monitoring_frontend
    bind *:8405
    
    # Route monitoring requests
    acl is_prometheus path_beg /prometheus
    acl is_grafana path_beg /grafana
    acl is_jaeger path_beg /jaeger
    
    use_backend prometheus_backend if is_prometheus
    use_backend grafana_backend if is_grafana
    use_backend jaeger_backend if is_jaeger

backend prometheus_backend
    server prometheus 172.30.0.20:9090 check

backend grafana_backend
    server grafana 172.30.0.30:3000 check

backend jaeger_backend
    server jaeger 172.30.0.40:16686 check